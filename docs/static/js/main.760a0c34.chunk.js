(this["webpackJsonpmusic-mining"]=this["webpackJsonpmusic-mining"]||[]).push([[0],{107:function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return a}));var r,c=n(37);function a(){return r||(r=Object(c.g)())}e.NODE_ENV}).call(this,n(25))},20:function(e,t){var n={APP_NAME:"JukeSoup",BASE_URI:Object({NODE_ENV:"production",PUBLIC_URL:"",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0,REACT_APP_CLIENT_ID:"7acd727f06d34ecfb1c6d8b76c97d36d",REACT_APP_FIREBASE_API_KEY:"AIzaSyDQfAAJqtKOKXEdRL1SfqS3Pj8VjAIqvzE",REACT_APP_FIREBASE_AUTH_DOMAIN:"music-mining.firebaseapp.com",REACT_APP_FIREBASE_PROJECT_ID:"music-mining",REACT_APP_STORAGE_BUCKET:"music-mining.appspot.com",REACT_APP_MESSAGING_SENDER_ID:"616247216727",REACT_APP_FIREBASE_APP_ID:"1:616247216727:web:13e1f76d2cc06a0ab3f112"}).REACT_APP_BASE_URI||"http://localhost:3000",SPOTIFY_API:"https://api.spotify.com/v1",SPOTIFY_ACCOUNTS_API:"https://accounts.spotify.com",SPOTIFY_CLIENT_ID:"7acd727f06d34ecfb1c6d8b76c97d36d",SPOTIFY_SCOPES:["user-read-playback-state","user-modify-playback-state","user-read-currently-playing","user-read-recently-played"],MONEY_SINGULAR:"ticket",MONEY_PLURAL:"tickets",MAX_MONEY:20};n.SPOTIFY_REDIRECT_URI="".concat(n.BASE_URI,"/callback"),e.exports=n},227:function(e,t,n){},228:function(e,t,n){},237:function(e,t){},239:function(e,t){},249:function(e,t){},251:function(e,t){},278:function(e,t){},279:function(e,t){},284:function(e,t){},286:function(e,t){},293:function(e,t){},312:function(e,t){},345:function(e,t,n){},347:function(e,t,n){},351:function(e,t,n){"use strict";n.r(t);var r=n(2),c=n(44),a=n(51),o=(n(227),n(19)),i=(n(228),n(103)),s=n(216),u=n(10),l=n(129),d=n(8),j=n(21),h=n(1),p=n.n(h),b=n(4),f=n(5),O=n(6),x=n(37),g=n(106),y=n.n(g),m=n(107),v=function(){if(localStorage.getItem("ORMDEBUG")){for(var e,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];(e=console).log.apply(e,["[ORM:DEBUG]"].concat(n,[{stack:new Error}]))}};v.group=function(e){return!1},v.groupEnd=function(){return!1};var _=function(){function e(){Object(f.a)(this,e)}return Object(O.a)(e,null,[{key:"setDb",value:function(t){v("Setting db connection to",t),e._dbconnection=t}},{key:"model",value:function(t,n){if(!n)return e._models[t];var r=new k(t,n,e._dbconnection);return e._models[t]=r,r}}]),e}();_._models={},_._dbconnection=m.a;var k=function(){function e(t,n,r){Object(f.a)(this,e),this._schema=n,this._collection=t,this._getdb=r,this._hooks={preCreate:function(){}}}return Object(O.a)(e,[{key:"preCreate",value:function(e){this._hooks.preCreate=e}},{key:"validate",value:function(e){for(var t=0,n=Object.entries(e);t<n.length;t++){var r=Object(u.a)(n[t],2),c=r[0],a=r[1];if("_id"!==c){if(console.log(c,this._schema[c]),!this._schema[c])throw Error("document has extra property '".concat(c,"'\n        Schema keys are ").concat(Object.keys(this._schema).join(", ")));if(Array.isArray(this._schema[c])){if(!Array.isArray(a))throw Error("Expected ".concat(c," to be an Array but was ").concat(typeof a))}else if(typeof this._schema[c]()!==typeof a)throw Error("Expected '".concat(c,"' to be type ").concat(typeof this._schema[c](),", but was ").concat(typeof a,"\n        Schema keys are ").concat(Object.keys(this._schema).join(", ")))}}return e}},{key:"create",value:function(){var e=Object(b.a)(p.a.mark((function e(){var t,n,r,c,a,o,i=arguments;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=i.length>0&&void 0!==i[0]?i[0]:{},n=i.length>1&&void 0!==i[1]?i[1]:{},r=n.fetchDoc,c=void 0===r||r,v("creating document ",t),this._hooks.preCreate(t),this.validate(t),a=this._getdb(),e.next=8,Object(x.a)(Object(x.b)(a,this._collection),t);case 8:if(o=e.sent,!c){e.next=12;break}return v("fetching document"),e.abrupt("return",this.findById(o.id,{cache:!1}));case 12:return e.abrupt("return",o);case 13:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"find",value:function(){var e=Object(b.a)(p.a.mark((function e(t){var n,r,c,a,o,i,s,u,l,d,h=arguments;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=h.length>1&&void 0!==h[1]?h[1]:{},c=r.document,a=void 0===c||c,v.group("find"),v("called with query",t),t._id&&(o=t._id,delete t._id),i=this._getdb(),v("using db",i),s=Object(x.b)(i,this._collection),v("using collection",s),u=x.h.apply(void 0,[s].concat(Object(j.a)(S(t)))),e.next=11,Object(x.f)(u);case 11:if(l=e.sent,null===(n=l.docs)||void 0===n?void 0:n.length){e.next=16;break}return v("find: no query found"),v.groupEnd(),e.abrupt("return",void 0);case 16:if(!o){e.next=21;break}return d=y()(l.docs,(function(e){return e.id===o})),v("found doc (by id): ",d),v.groupEnd(),e.abrupt("return",a?[w(d)]:[d]);case 21:return v("found docs (as snapshots):",l.docs),v.groupEnd(),e.abrupt("return",a?l.docs.map(w):l.docs);case 24:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"findOne",value:function(){var e=Object(b.a)(p.a.mark((function e(t){var n,r,c,a,o=arguments;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=o.length>1&&void 0!==o[1]?o[1]:{},r=n.document,c=void 0===r||r,v.group("findOne"),e.next=4,this.find(t,{document:c});case 4:if(a=e.sent){e.next=9;break}return v("no docs found"),v.groupEnd(),e.abrupt("return");case 9:return v("fond ".concat(a.length," docs, first one is "),a[0]),v.groupEnd(),e.abrupt("return",a[0]);case 12:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"findById",value:function(){var e=Object(b.a)(p.a.mark((function e(t){var n,r,c,a,o,i,s,u,l=arguments;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=l.length>1&&void 0!==l[1]?l[1]:{},r=n.cache,c=void 0===r||r,a=n.document,o=void 0===a||a,v.group("findById"),v("using id ",t,{cache:c},this._collection),i=this._getdb(),s=Object(x.c)(i,"/".concat(this._collection,"/").concat(t)),e.next=7,c?Object(x.d)(s):Object(x.e)(s);case 7:if(u=e.sent,v.groupEnd(),o){e.next=12;break}return v("returning snapshot rather than document"),e.abrupt("return",o);case 12:return e.abrupt("return",w(u));case 13:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"findOrCreate",value:function(){var e=Object(b.a)(p.a.mark((function e(t){var n,r;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return v.group("findOrCreate"),v("called with queryObj =",t),e.next=4,this.findOne(t);case 4:if(n=e.sent){e.next=13;break}return t._id||delete t._id,v("doc not found, creating."),e.next=10,this.create(t);case 10:return r=e.sent,v.groupEnd(),e.abrupt("return",r);case 13:return v("Found doc:",n),v.groupEnd(),e.abrupt("return",n);case 16:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"update",value:function(){var e=Object(b.a)(p.a.mark((function e(t,n){var r,c,a,o,i,s,l,d,j,h;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return v.group("update"),e.next=3,this.findOne(t);case 3:if(r=e.sent){e.next=8;break}return v("Could not find doc!"),v.groupEnd(),e.abrupt("return",null);case 8:c=this._getdb(),a=Object(x.c)(c,"/".concat(this._collection,"/").concat(r._id)),v.groupEnd(),o=[],i=0,s=Object.entries(n);case 13:if(!(i<s.length)){e.next=22;break}return l=Object(u.a)(s[i],2),d=l[0],j=l[1],e.next=17,Object(x.i)(a,d,j);case 17:h=e.sent,o.push(h);case 19:i++,e.next=13;break;case 22:return e.abrupt("return",o);case 23:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()}]),e}();function S(e){for(var t=[],n=0,r=Object.entries(e);n<r.length;n++){var c=Object(u.a)(r[n],2),a=c[0],o=c[1];t.push(Object(x.j)(a,"==",o))}return t}function w(e){if(null===e||void 0===e?void 0:e.data())return Object(d.a)(Object(d.a)({},e.data()),{},{_id:e.id})}var A=n(20),E={_authId:String,money:Number,score:Number,displayName:String},T=_.model("User",E);T.preCreate((function(e){var t;e.score=e.score||0,e.money=null!==(t=e.money)&&void 0!==t?t:A.MAX_MONEY}));var I=T;function P(){var e=Object(r.useState)(null),t=Object(u.a)(e,2),n=t[0],c=t[1];return Object(r.useEffect)((function(){var e=Object(l.a)();Object(l.c)(e).then((function(){return!0})).catch((function(e){console.error("Could not sign in with firebase auth:\n",e.code,e.message)})),Object(l.b)(e,(function(e){console.log("user is ",null===e||void 0===e?void 0:e.uid),(null===e||void 0===e?void 0:e.uid)&&I.findOrCreate({_authId:e.uid}).then((function(e){localStorage.setItem("_id",e._id),(null===n||void 0===n?void 0:n._id)!==e._id&&c(n)}))}))})),n}var C=n(3);function R(){var e=Object(r.useState)(""),t=Object(u.a)(e,2),n=t[0],c=t[1];return setTimeout((function(){return c(Object(C.jsx)("div",{children:"Loading"}))}),1200),Object(C.jsx)(C.Fragment,{children:n})}function N(e){var t=e.children,n={width:"100vw",maxWidth:"520px",midWidth:"200px",padding:"14px"};return e.align&&(n.textAlign=e.align),Object(C.jsx)("div",{className:"mobilish",style:n,children:t})}var q=n(368),D=n(217),F=n(357);var U=function(e){var t=Object(o.t)();return null===P()?Object(C.jsx)(R,{}):Object(C.jsxs)(N,{children:[Object(C.jsx)("br",{}),Object(C.jsx)("br",{}),Object(C.jsxs)("h1",{children:[Object(C.jsx)(s.a,{})," Find a Soup"]}),Object(C.jsx)("hr",{}),Object(C.jsx)("br",{}),Object(C.jsxs)(q.a,{children:[Object(C.jsx)(q.a.Text,{children:"2-word phrase:"}),Object(C.jsx)(D.a,{placeholder:'(e.g. "shining pearl")'}),Object(C.jsx)(F.a,{variant:"outline-primary",children:"Find"})]}),Object(C.jsx)("br",{}),Object(C.jsxs)("div",{style:{display:"flex",alignContent:"center",flexDirection:"column"},children:[Object(C.jsx)("div",{style:{color:"#888",textAlign:"center",padding:"16px"},children:"or"}),Object(C.jsx)(F.a,{style:{width:"100%"},variant:"success",onClick:function(){return t("/soup/new")},children:"Create one"})]})]})},B=n(358),L=n(359),Y=n(218),M=n(365),K=n(90),z=["shining","cool","fun","rad","good","nice","helpful","hip","musical","kind","free","great","bad","hot","cold","warm","frozen","tall","short","quick","red","green","blue","square","smart","long","rich","calm","windy","round","solid","liquid","meta","cyber","swanky","fruity"],W=["pearl","mom","dad","daddy","boy","girl","car","trick","mine","quarry","pot","egg","seltzer","gas","power","iphone","salt","pepper","bed","table","soda","chair","rug","bean","ice","yoyo","rug","can","wheel","yoga","button","stick","fire","rain","sun","god","gold","cup","app","bread","box","toy","tea"];function H(){return[z[Math.floor(Math.random()*z.length)],W[Math.floor(Math.random()*W.length)]]}var V={leader:String,name:String,queue:[],_authId:String,phrase:String,created:Object,currentTrack:Object,startedAt:Object,isPlaying:Boolean,duration:Number},G=_.model("Quarry",V);G.preCreate((function(e){e.queue=[],e.created=new Date}));var J=G;function Q(e){var t=Object(o.t)(),n=P(),c=Object(r.useState)(H()),a=Object(u.a)(c,2),i=a[0],s=a[1],l=Object(r.useState)(!1),d=Object(u.a)(l,2),j=d[0],h=d[1],p=Object(r.useState)(""),b=Object(u.a)(p,2),f=b[0],O=b[1],x=Object(r.useState)(!1),g=Object(u.a)(x,2),y=g[0],m=g[1],v=function(e){if(!1===e.currentTarget.checkValidity())return e.preventDefault(),void e.stopPropagation();h(!0),f&&(m(!0),J.create({leader:n._id,_authId:n.authId,phrase:i.join("-"),name:f}).then((function(e){console.log("new quarry",e),t("/soup/".concat(e._id))})))};return null===n?Object(C.jsx)(R,{}):Object(C.jsx)(N,{children:Object(C.jsxs)(B.a,{fluid:!0,children:[Object(C.jsxs)(L.a,{md:"auto",className:"justify-content-center",children:[Object(C.jsx)(Y.a,{sm:!0,style:{padding:"0 4px 0 0"},children:Object(C.jsx)("h1",{children:"Start a soup,"})}),Object(C.jsx)(Y.a,{sm:!0,style:{padding:"0"},children:Object(C.jsx)("h1",{children:"discover music."})})]}),Object(C.jsx)(L.a,{children:Object(C.jsx)("hr",{})}),Object(C.jsx)(L.a,{children:Object(C.jsxs)(M.a,{noValidate:!0,validated:j,onSubmit:v,action:"",children:[Object(C.jsxs)(M.a.Group,{controlId:"name",children:[Object(C.jsx)(M.a.Label,{children:"Soup Name"}),Object(C.jsx)(M.a.Control,{required:!0,type:"input",placeholder:"(e.g. Nick's Soup)",value:f,onChange:function(e){O(e.target.value)}})]}),Object(C.jsx)("br",{}),Object(C.jsx)("div",{className:"d-md-none",style:{textAlign:"center"},children:"Your phrase:"}),Object(C.jsxs)(q.a,{style:{maxWidth:"480px"},children:[Object(C.jsx)(q.a.Text,{className:"d-none d-md-inline",children:"Your phrase:"}),Object(C.jsx)(D.a,{style:{textAlign:"center",fontFamily:"monospace",color:"red"},readOnly:!0,value:i[0],"aria-label":"First word of phrase"}),Object(C.jsx)(D.a,{style:{textAlign:"center",fontFamily:"monospace",color:"red"},readOnly:!0,value:i[1],"aria-label":"Second word of phrase"}),Object(C.jsx)(F.a,{className:"d-none d-md-inline",variant:"outline-secondary",onClick:function(){return s(H())},children:Object(C.jsx)(K.b,{})})]}),Object(C.jsx)(F.a,{className:"d-md-none",style:{width:"100%"},variant:"outline-secondary",onClick:function(){return s(H())},children:Object(C.jsx)(K.b,{})}),Object(C.jsx)(M.a.Text,{className:"text-muted",children:"This is helps friends find you."}),Object(C.jsx)("br",{}),Object(C.jsx)("br",{}),Object(C.jsxs)(F.a,{className:y?"btn-secondary":"btn-success",style:{width:"100%"},type:"",onClick:v,disabled:y,children:[" ",y?"working \ud83d\udca6":"Create"]})]})})]})})}var X=n(219),$=n.n(X),Z=n(127),ee=n.n(Z),te="spotifyAccessToken_DO_NOT_SHARE",ne="spotifyRefreshToken",re=new(function(){function e(){Object(f.a)(this,e)}return Object(O.a)(e,[{key:"accessToken",get:function(){return localStorage.getItem(te)},set:function(e){localStorage.setItem(te,e)}},{key:"refreshToken",get:function(){return localStorage.getItem(ne)},set:function(e){localStorage.setItem(ne,e)}}]),e}()),ce=new(function(){function e(){Object(f.a)(this,e),this.axios=this._createAxiosWithSpotifyAuth()}return Object(O.a)(e,[{key:"_createAxiosWithSpotifyAuth",value:function(){return ee.a.create({baseURL:A.SPOTIFY_API,headers:{Authorization:"Bearer ".concat(re.accessToken)}})}},{key:"setAccessToken",value:function(e){re.accessToken=e,this.axios=this._createAxiosWithSpotifyAuth()}},{key:"setRefreshToken",value:function(e){re.refreshToken=e,this.axios=this._createAxiosWithSpotifyAuth()}},{key:"setTokensWithCode",value:function(){var e=Object(b.a)(p.a.mark((function e(t,n){var r,c,a;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(r=new URLSearchParams).append("grant_type","authorization_code"),r.append("code",t),r.append("redirect_uri",A.SPOTIFY_REDIRECT_URI),r.append("client_id",A.SPOTIFY_CLIENT_ID),r.append("code_verifier",n),c="".concat(A.SPOTIFY_ACCOUNTS_API,"/api/token"),e.next=9,ee()({url:c,method:"post",data:r,headers:{"Content-Type":"application/x-www-form-urlencoded"}});case 9:return a=e.sent,this.setAccessToken(a.data.access_token),this.setRefreshToken(a.data.refresh_token),e.abrupt("return",a);case 13:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"request",value:function(){var e=Object(b.a)(p.a.mark((function e(){var t,n,r=arguments;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.axios.apply(this,r);case 3:t=e.sent,e.next=13;break;case 6:if(e.prev=6,e.t0=e.catch(0),"The access token expired"!==(null===(n=e.t0.response)||void 0===n?void 0:n.data.error.message)){e.next=13;break}return console.log("access token expired, trying new token"),e.next=12,this.requestAccessTokenFromRefreshToken();case 12:return e.abrupt("return",this.request.apply(this,r));case 13:return e.abrupt("return",t);case 14:case"end":return e.stop()}}),e,this,[[0,6]])})));return function(){return e.apply(this,arguments)}}()},{key:"requestAccessTokenFromRefreshToken",value:function(){var e=Object(b.a)(p.a.mark((function e(){var t,n;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("starting refresh flow"),t=new URLSearchParams({grant_type:"refresh_token",refresh_token:re.refreshToken,client_id:A.SPOTIFY_CLIENT_ID}),e.prev=2,e.next=5,ee()({url:"".concat(A.SPOTIFY_ACCOUNTS_API,"/api/token"),method:"post",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:t});case 5:return n=e.sent,re.accessToken=n.data.access_token,re.refreshToken=n.data.refresh_token,e.abrupt("return",n);case 11:if(e.prev=11,e.t0=e.catch(2),"Request failed with status code 400"!==e.t0.message&&!/The access token expired/.test(e.t0.message)){e.next=18;break}alert("Please reconnect Spotify"),window.location.href="/spotifyConnect",e.next=21;break;case 18:throw console.error("HANDLE THIS IN spotify.js"),console.log(e.t0),e.t0;case 21:case"end":return e.stop()}}),e,null,[[2,11]])})));return function(){return e.apply(this,arguments)}}()}]),e}()),ae="codeVerifier_DO_NOT_SHARE",oe=$()(48),ie=oe.code_verifier,se=oe.code_challenge,ue=new URLSearchParams;ue.append("client_id",A.SPOTIFY_CLIENT_ID),ue.append("response_type","code"),ue.append("scope",A.SPOTIFY_SCOPES.join(" ")),ue.append("redirect_uri",A.SPOTIFY_REDIRECT_URI),ue.append("code_challenge_method","S256"),ue.append("code_challenge",se),console.log("using challenge ",se);var le="".concat(A.SPOTIFY_ACCOUNTS_API,"/authorize?").concat(ue.toString());function de(){var e=Object(o.r)(),t=Object(o.t)(),n=new URLSearchParams(e.search),r=n.get("code"),c=n.get("error");if(c)return"access_denied"===c?Object(C.jsx)("h1",{children:"Oh."}):Object(C.jsxs)(C.Fragment,{children:[Object(C.jsx)("h1",{children:"Yikes."}),Object(C.jsx)("h6",{children:"Just walk away"})]});if(r){var a=localStorage.getItem(ae);return ce.setTokensWithCode(r,a).then((function(e){return console.log(e),ce.axios("/me/player/currently-playing")})).then((function(){return t("/soup/new")})).catch((function(e){return console.error(e.message)})),Object(C.jsx)(R,{})}return localStorage.setItem(ae,ie),Object(C.jsxs)(N,{align:"center",children:[Object(C.jsx)("h1",{children:"Connect Your Spotify Account"}),Object(C.jsxs)("p",{children:["Let ",A.APP_NAME," control your music player on Spotify. Connect an account you plan on playing loud and proud."]}),Object(C.jsx)("br",{}),Object(C.jsx)(F.a,{variant:"outline-dark",href:le,children:"Authorize with Spotify"}),Object(C.jsx)("br",{}),Object(C.jsx)("br",{}),Object(C.jsx)("br",{}),Object(C.jsx)("small",{children:"We don't modify any data, such as playlists or liked songs (or anything else)"})]})}var je=n(51).useParams;function he(){var e=je().phrase,t=Object(o.t)();/^\w{1,10}-\w{1,10}$/.test(e)||t("/");var n=Object(r.useState)(null),c=Object(u.a)(n,2),a=c[0],i=c[1],s=P();return console.log("its ",e),null===s?Object(C.jsx)(R,{}):(J.find({phrase:e}).then((function(e){1===(null===e||void 0===e?void 0:e.length)?t("/soup/".concat(e[0]._id)):(null===e||void 0===e?void 0:e.length)>1?(console.log("todo"),i(e)):t("/")})),null===a?Object(C.jsx)(R,{}):Object(C.jsx)("div",{children:"This is a list of soups (TODO)"}))}var pe=n(91),be=n(81),fe=Object(r.createContext)({track:null,isPlaying:!1,startFrom:0,updateSpotify:!0}),Oe=n(220),xe=n.n(Oe),ge="lastMoneyUpdate",ye=18e4,me=null;function ve(){null!==me?(clearTimeout(me),me=null):console.warn("stopMoneyLoop - nothing to stop")}var _e=n(367),ke=n(360);function Se(e){var t=e.track;return t?Object(C.jsxs)("div",{className:"d-flex",children:[Object(C.jsx)("div",{style:{margin:"16px"},children:Object(C.jsx)("img",{src:t.album.images[2].url,alt:"Track album"})}),Object(C.jsxs)("div",{style:{margin:"16px"},children:[Object(C.jsxs)("div",{className:"fw-bold",children:[t.name," ",t.explicit&&Object(C.jsx)(ke.a,{bg:"secondary",children:"Explicit"}),"\xa0"]}),Object(C.jsx)("div",{children:t.artists.map((function(e){return e.name})).join(", ")})]})]}):null}n(345);function we(e){var t=e.votes,n=e.track,r=e.onVote;return Object(C.jsxs)("div",{className:"container",children:[Object(C.jsxs)("div",{className:"voteWindow",children:[Object(C.jsx)("div",{className:"clickable",onClick:function(){return r("up",{track:n})},children:Object(C.jsx)(pe.c,{})}),Object(C.jsx)("div",{children:Object(C.jsx)("h3",{children:t})}),Object(C.jsx)("div",{className:"clickable",onClick:function(){return r("down",{track:n})},children:Object(C.jsx)(pe.a,{})})]}),Object(C.jsx)("div",{children:Object(C.jsx)(Se,{track:n})})]})}function Ae(e){var t=e.songs,n=e.onVote;if(!t)throw Error("SongQueue component must have props `songs`");var r=function(){return n.apply(void 0,arguments)};return t.length?Object(C.jsx)(C.Fragment,{children:Object(C.jsx)(_e.a,{children:Object(C.jsx)(_e.a.Text,{children:t.map((function(e){return Object(C.jsx)(we,{votes:e.votes,track:e.track,onVote:r})}))})})}):Object(C.jsx)(C.Fragment,{children:Object(C.jsx)(_e.a,{children:Object(C.jsxs)(_e.a.Title,{children:[Object(C.jsx)(K.a,{})," No songs added yet"]})})})}var Ee=n(362),Te=n(361),Ie=n(364),Pe=n(370),Ce=n(366);function Re(e){var t=e.phrase;return Object(C.jsx)(Ce.a,{defaultActiveKey:"0",children:Object(C.jsxs)(Ce.a.Item,{eventKey:"0",children:[Object(C.jsx)(Ce.a.Header,{children:"Bring your friends here \ud83d\ude4b\u200d\u2640\ufe0f"}),Object(C.jsxs)(Ce.a.Body,{children:["Tell them to enter ",Object(C.jsxs)("code",{children:['"',t.replace("-"," "),'" ']}),"on ",A.BASE_URI,". They can also go to ",Object(C.jsx)("a",{href:"".concat(A.BASE_URI,"/").concat(t),children:"".concat(A.BASE_URI,"/").concat(t)})," directly."]})]})})}var Ne,qe=n(128),De=n(369),Fe=n(221),Ue=n(363);function Be(e){var t=e.show,n=e.track,r=e.handler;return null===n?null:Object(C.jsxs)(Ue.a,{show:t,children:[Object(C.jsx)(Ue.a.Header,{children:Object(C.jsx)(Ue.a.Title,{children:"Nominating Song"})}),Object(C.jsxs)(Ue.a.Body,{children:["Do you want to spend ",Object(C.jsxs)("b",{children:["1 ",A.MONEY_SINGULAR]})," to nominate this song?",Object(C.jsx)("br",{}),Object(C.jsx)(Se,{track:n})]}),Object(C.jsxs)(Ue.a.Footer,{children:[Object(C.jsx)(F.a,{variant:"outline-secondary",onClick:function(){return r(!1)},children:"Close"}),Object(C.jsxs)(F.a,{variant:"dark",onClick:function(){return r(!0)},children:["Submit\xa0 ",Object(C.jsxs)(ke.a,{bg:"primary",pill:!0,children:["-1 ",Object(C.jsx)(be.c,{})]})]})]})]})}function Le(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.soupId,n=e.eventHandler,c=void 0===n?function(){}:n,a=Object(r.useState)(""),o=Object(u.a)(a,2),i=o[0],s=o[1],l=Object(r.useState)([]),d=Object(u.a)(l,2),h=d[0],p=d[1],b=Object(r.useState)(!1),f=Object(u.a)(b,2),O=f[0],x=f[1],g=Object(r.useState)(null),y=Object(u.a)(g,2),m=y[0],v=y[1],_=Object(r.useState)(!1),k=Object(u.a)(_,2),S=k[0],w=k[1],E=P();function T(){ce.request("/search",{params:{q:i,type:"track",limit:6}}).then((function(e){console.log(e),e&&p(e.data.tracks.items)}))}function R(e){v(e),x(!0)}function N(e){x(!1),e&&!S&&(w(!0),I.findById(E).then((function(e){if(e.money<1)throw alert("You're too broke! Wait a few minutes for your ".concat(A.MONEY_PLURAL," to be replenished.")),Error("Silent");var t=e.money-1;return I.update({_id:E},{money:t}).then((function(e){return c("updateUser"),c("selectedTrack",m),e}))})).then((function(){return J.findById(t)})).then((function(e){var t=[{votes:5,track:m}].concat(Object(j.a)(e.queue));return c("updateQueue",t),J.update({_id:e._id},{queue:t})})).catch((function(e){if("silent"===e.message.toLowerCase())return e;throw e})).finally((function(){w(!1)})),E.money<1)&&console.log("no money!")}function U(e,t){var n=new Fe.Time(e.duration_ms);return Object(C.jsxs)(De.a.Item,{className:"d-flex justify-content-between align-items-start",action:!0,onClick:function(){return R(e)},children:[Object(C.jsxs)("div",{children:[Object(C.jsxs)("div",{className:"fw-bold",children:[e.name,"\xa0",e.explicit&&Object(C.jsx)(ke.a,{bg:"secondary",children:"Explicit"}),"\xa0",e.popularity>75&&Object(C.jsx)(qe.a,{size:"1.3em",style:{color:"#ff8c00"}}),e.popularity>83&&Object(C.jsx)(qe.a,{size:"1.3em",style:{color:"#ff8c00"}}),e.popularity>92&&Object(C.jsx)(qe.a,{size:"1.3em",style:{color:"#ff8c00"}})]}),Object(C.jsx)("div",{children:e.artists.map((function(e){return e.name})).join(", ")})]}),Object(C.jsx)("div",{style:{fontFamily:"monospace"},children:n.toString("s")})]},t)}return Object(C.jsxs)(C.Fragment,{children:[Object(C.jsx)(q.a,{children:Object(C.jsx)(D.a,{placeholder:"Type to search...",value:i,onChange:function(e){return s(e.target.value)}})}),Object(C.jsx)(F.a,{onClick:T,children:"Search"}),Object(C.jsx)("br",{}),Object(C.jsx)(De.a,{children:h.map(U)}),Object(C.jsx)(Be,{show:O,track:m,handler:N})]})}var Ye=function(){var e=Object(b.a)(p.a.mark((function e(){var t,n;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ce.request("/me/player/recently-played",{params:{limit:1}});case 2:return n=e.sent,e.abrupt("return",null===(t=n.data.items[0])||void 0===t?void 0:t.track);case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),Me=function(){var e=Object(b.a)(p.a.mark((function e(t,n,r){var c,a,o;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ce.request("/me/player");case 2:return c=e.sent,e.next=5,Ye();case 5:if(a=e.sent,o=a.uri,console.log("LAST PLAYED IS ",o),console.log("PLAYER STATE ",c.data),c.data.is_playing){e.next=15;break}return console.log("\ud83d\udea8 Nothing playing! Calling",t.toString()),clearInterval(Ne),Ne=null,t(),e.abrupt("return");case 15:console.log("STATE",c);case 16:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),Ke="TRACK_END";function ze(e){return We.apply(this,arguments)}function We(){return(We=Object(b.a)(p.a.mark((function e(t){return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",ce.request("/me/player/play",{method:"put",data:{uris:[t]}}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function He(){return(He=Object(b.a)(p.a.mark((function e(t){var n,r,c,a,o=arguments;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=o.length>1&&void 0!==o[1]?o[1]:{},r=n.offsetMs,void 0===r?0:r,n.currentUri,console.group("playTrack"),e.next=4,ce.request("/me/player");case 4:if(c=e.sent,console.log({playerState:c}),204!==c.status){e.next=13;break}return e.next=9,Ye();case 9:if(e.sent.uri===t){e.next=13;break}return console.log("\u25b6\ufe0f Playing current track as its not the last track played already"),e.abrupt("return",ze(t));case 13:if(c.data.item.uri!==t){e.next=17;break}return console.log("song is playing right now, will not re-play",c.data),console.groupEnd(),e.abrupt("return");case 17:return console.log("\ud83c\udf10 Making request to Spotify to play track"),e.next=20,ze(t);case 20:a=e.sent,console.log("\ud83c\udfb5\ud83c\udfb5 Response from play request",a),console.groupEnd();case 23:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var Ve=function(e){var t=e.eventHandler,n=e.soupId;if(!n)return Object(C.jsx)(R,{});var r=function(){var e=Object(b.a)(p.a.mark((function e(t){return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",J.update({_id:n},t));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();return Object(C.jsx)(fe.Consumer,{children:function(e){if(null===e)return Object(C.jsx)("div",{children:"Talking to Spotify.."});console.group("Player:onValueChange");var n=e.isPlaying,c=e.track,a=e.startFrom,o=e.updateSpotify;return console.log("new values",{isPlaying:n,track:c,startFrom:a,updateSpotify:o}),n?c?(console.log("sending to playTrack with uri ",c.uri),function(e){return He.apply(this,arguments)}(c.uri).catch((function(e){t("ERROR_PLAY_FAILED",e)})).then((function(){var e;return e=function(){return t(Ke)},console.log("starting player check loop"),Ne||(Ne=setInterval((function(){return Me(e)}),7200)),setTimeout((function(){return Me((function(){return t(Ke)}))}),c.duration_ms-800),r({isPlaying:!0,duration:c.duration_ms,startedAt:new Date})})),console.groupEnd(),Object(C.jsx)(Se,{track:c})):(console.log("there is no track, so send TRACK_END event"),console.groupEnd(),t(Ke),Object(C.jsx)("div",{children:"Getting next song..."})):Object(C.jsx)("div",{children:"paused"})}})};n(347);function Ge(){var e=Object(o.w)().id,t=Object(r.useState)(null),n=Object(u.a)(t,2),c=n[0],a=n[1],i=Object(r.useState)(null),s=Object(u.a)(i,2),l=s[0],j=s[1],h=Object(r.useState)(!1),f=Object(u.a)(h,2),O=f[0],x=f[1],g=Object(r.useState)(null),m=Object(u.a)(g,2),v=m[0],_=m[1],k=Object(r.useState)(null),S=Object(u.a)(k,2),w=S[0],E=S[1],T=Object(r.useState)(!1),q=Object(u.a)(T,2),D=q[0],U=q[1],B=Object(r.useState)("songs"),L=Object(u.a)(B,2),Y=L[0],M=L[1],K=P();Object(r.useEffect)((function(){if(null===c)return I.findById(K).then((function(t){return _(t,[c,K,e])})),J.findById(e).then((function(e){if(!e)return console.log("setting error"),j(404);a(e),E({isPlaying:e.isPlaying,track:e.currentTrack,updateSpotify:!0}),e.queue.length||M("new"),function(){var e=function(){var t=Object(b.a)(p.a.mark((function t(){var n,r,c,a,o,i;return p.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=+localStorage.getItem(ge),r=Date.now(),!(n+ye<r)){t.next=15;break}return c=3*Math.floor((r-n)/ye),a=localStorage.getItem("_id"),t.next=7,I.findById(a);case 7:return o=t.sent,i=o.money+c<A.MAX_MONEY?o.money+c:A.MAX_MONEY,t.next=11,I.update({_id:a},{money:i});case 11:localStorage.setItem(ge,Date.now()),me=setTimeout(e,ye),t.next=17;break;case 15:return me=setTimeout(e,n+ye-r),t.abrupt("return",me);case 17:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}();if(null===me)return e();console.error("startMoneyLoop - cannot start loop when already running")}()})),ve}));var z=function(t,n){if(!O)if("updateUser"===t)I.findById(K).then((function(t){return _(t,[c,K,e])}));else if("updateQueue"===t)console.log("updating main queue data",n),a(Object(d.a)(Object(d.a)({},c),{queue:n})),M("songs");else if(["up","down"].includes(t)){x(!0),y()(c.queue,(function(e){return e.track.id===n.track.id})).votes+="up"===t?1:-1,c.queue=(c.queue,xe()(c.queue,"votes").reverse()),J.update({_id:c._id},{queue:c.queue}).then((function(){return a(c)})).finally((function(){return x(!1)}))}};if(l)return console.log(l),404===l?Object(C.jsxs)(N,{children:[Object(C.jsxs)("h1",{children:["Quarry not found ",Object(C.jsx)("code",{children:"404"})]}),Object(C.jsx)("p",{children:"It might have been deleted. Or we might've screwed up (probs not tbh)"}),Object(C.jsx)("p",{children:Object(C.jsx)("a",{href:"/",children:"Back to the pantry"})})]}):Object(C.jsxs)(N,{children:[Object(C.jsx)("h1",{children:"Uh oh"}),Object(C.jsx)("p",{children:"Don't look at me."}),Object(C.jsx)("p",{children:Object(C.jsx)("a",{href:"/",children:"Just go away"})})]});if(null===c)return Object(C.jsx)(R,{});var W=Object(C.jsxs)(C.Fragment,{children:[Object(C.jsx)(be.c,{})," ",null===v||void 0===v?void 0:v.money]}),H=!c.queue.length&&!c.currentTrack;return Object(C.jsx)(fe.Provider,{value:w,children:Object(C.jsxs)(N,{align:"left",children:[Object(C.jsxs)("section",{children:[Object(C.jsxs)("span",{className:"header",children:[Object(C.jsxs)("h2",{children:[c.name," "]}),Object(C.jsx)(Ee.a,{placement:"bottom",delay:150,overlay:function(e){return Object(C.jsx)(Te.a,Object(d.a)(Object(d.a)({},e),{},{children:"Add a song first"}))},children:Object(C.jsx)(F.a,{variant:"success",disabled:H,onClick:function(){var e=!w.isPlaying;E(Object(d.a)(Object(d.a)({},w),{},{isPlaying:e,updateSpotify:!0})),J.update({_id:c._id},{isPlaying:e}).catch(console.error)},children:Object(C.jsx)(be.b,{})})})]}),Object(C.jsx)("h4",{children:"number"===typeof(null===v||void 0===v?void 0:v.money)?W:" "})]}),Object(C.jsx)(Re,{phrase:c.phrase}),Object(C.jsx)("br",{}),Object(C.jsx)(Ve,{eventHandler:function(e){if(console.log("# player event #"),"TRACK_END"===e){var t;if(D)return void console.info("player locked");U(!0),console.group("onPlayerEvent:TRACK_END"),console.log("getting next track");var n=null===(t=c.queue.pop())||void 0===t?void 0:t.track;if(console.log("next track is ",n),!n)return console.info("no next track, pausing"),E(Object(d.a)(Object(d.a)({},w),{},{isPlaying:!1,updateSpotify:!0})),U(!1),J.update({_id:c._id},{isPlaying:!1}).catch(console.error),void console.groupEnd();console.log("SOUP; updating with next track",n),J.update({_id:c._id},{queue:c.queue,currentTrack:n,startedAt:new Date,isPlaying:w.isPlaying}).then((function(){return a(c)})).then((function(){console.log("setting player values"),E(Object(d.a)(Object(d.a)({},w),{},{track:n,startAt:0}))})).catch((function(e){alert(e),E(Object(d.a)(Object(d.a)({},w),{},{isPlaying:!1}))})).finally((function(){console.groupEnd(),U(!1)}))}},soupId:null===c||void 0===c?void 0:c._id}),Object(C.jsxs)(Ie.a,{activeKey:Y,onSelect:M,className:"mb-3",children:[Object(C.jsx)(Pe.a,{eventKey:"songs",title:Object(C.jsxs)(C.Fragment,{children:[Object(C.jsx)(be.a,{})," Songs"]}),children:Object(C.jsx)(Ae,{songs:c.queue,onVote:z})}),Object(C.jsx)(Pe.a,{eventKey:"new",title:Object(C.jsxs)(C.Fragment,{children:[Object(C.jsx)(pe.b,{})," New "]}),children:Object(C.jsx)(Le,{eventHandler:z,soupId:e})})]})]})})}var Je={display:"flex",justifyContent:"center"};var Qe=function(){return Object(i.a)({apiKey:"AIzaSyDQfAAJqtKOKXEdRL1SfqS3Pj8VjAIqvzE",authDomain:"music-mining.firebaseapp.com",projectId:"music-mining",storageBucket:"music-mining.appspot.com",messagingSenderId:"616247216727",appId:"1:616247216727:web:13e1f76d2cc06a0ab3f112"}),Object(C.jsx)("div",{className:"App",style:Je,children:Object(C.jsxs)(o.f,{children:[Object(C.jsx)(o.d,{path:"/",element:Object(C.jsx)(U,{})}),Object(C.jsx)(o.d,{path:"/spotifyConnect",element:Object(C.jsx)(de,{})}),Object(C.jsx)(o.d,{path:"/callback",element:Object(C.jsx)(de,{})}),Object(C.jsx)(o.d,{path:"/soup/new",element:Object(C.jsx)(Q,{})}),Object(C.jsx)(o.d,{path:"/soup/:id",element:Object(C.jsx)(Ge,{})}),Object(C.jsx)(o.d,{path:"/:phrase",element:Object(C.jsx)(he,{})})]})})},Xe=(n(350),{apiKey:"AIzaSyDQfAAJqtKOKXEdRL1SfqS3Pj8VjAIqvzE",authDomain:"music-mining.firebaseapp.com",projectId:"music-mining",storageBucket:"music-mining.appspot.com",messagingSenderId:"616247216727",appId:"1:616247216727:web:13e1f76d2cc06a0ab3f112"});console.log("Initializing Firebase app with config",Xe);var $e=Object(i.a)(Xe);Object(m.a)($e);c.render(Object(C.jsx)(a.BrowserRouter,{children:Object(C.jsx)(Qe,{})}),document.getElementById("root"))}},[[351,1,2]]]);
//# sourceMappingURL=main.760a0c34.chunk.js.map